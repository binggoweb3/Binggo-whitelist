<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BINGGO Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Space+Grotesk:wght@600;700&display=swap" rel="stylesheet">

<style>
body{
  font-family:Inter,sans-serif;
  background:radial-gradient(circle at top,#0b1220,#020617);
}
.glass{
  background:rgba(255,255,255,.06);
  backdrop-filter:blur(16px);
  border:1px solid rgba(255,255,255,.1);
}
</style>
</head>

<body class="text-white min-h-screen">

<!-- HEADER -->
<header class="glass px-8 py-6 flex justify-between items-center">
  <h1 class="text-2xl font-bold font-[Space_Grotesk]">BINGGO Admin</h1>
  <button onclick="logout()" class="px-4 py-2 bg-red-600 rounded-lg text-sm">
    Logout
  </button>
</header>

<main class="p-8 max-w-7xl mx-auto space-y-10">

<!-- STATS -->
<section class="grid md:grid-cols-4 gap-6">
  <div class="glass p-6 rounded-xl">
    <p class="text-sm text-white/60">Total Wallet</p>
    <h2 id="totalWallet" class="text-3xl font-bold">0</h2>
  </div>
  <div class="glass p-6 rounded-xl">
    <p class="text-sm text-white/60">Banned User</p>
    <h2 id="bannedCount" class="text-3xl font-bold text-red-400">0</h2>
  </div>
  <div class="glass p-6 rounded-xl">
    <p class="text-sm text-white/60">Total Referral</p>
    <h2 id="totalReferral" class="text-3xl font-bold">0</h2>
  </div>
  <div class="glass p-6 rounded-xl">
    <p class="text-sm text-white/60">Top Referral</p>
    <h2 id="topReferral" class="text-3xl font-bold">0</h2>
  </div>
</section>

<!-- ACTIONS -->
<section class="flex gap-4">
  <button onclick="exportCSV()" class="bg-green-600 px-6 py-3 rounded-lg">
    Export CSV
  </button>
</section>

<!-- TABLE -->
<section class="glass rounded-2xl overflow-hidden">
<table class="w-full text-sm">
<thead class="bg-white/10">
<tr>
  <th class="px-4 py-3 text-left">Wallet</th>
  <th class="px-4 py-3">X</th>
  <th class="px-4 py-3">Ref Code</th>
  <th class="px-4 py-3">Status</th>
  <th class="px-4 py-3 text-right">Action</th>
</tr>
</thead>
<tbody id="table" class="divide-y divide-white/10"></tbody>
</table>
</section>

</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  onSnapshot, 
  doc, 
  updateDoc 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { 
  getAuth, 
  onAuthStateChanged, 
  signOut 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

/* FIREBASE CONFIG */
const firebaseConfig={
  apiKey:"AIzaSyC9D_9HQ-IB65E3c2KKcH7tSOE1pAammvM",
  authDomain:"binggo---whitelist.firebaseapp.com",
  projectId:"binggo---whitelist",
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const auth=getAuth(app);

/* AUTH GUARD */
onAuthStateChanged(auth,user=>{
  if(!user){
    location.href="./login.html";
  }
});

/* DOM */
const table=document.getElementById("table");
let bannedCount=0,totalReferral=0,maxReferral=0;

/* REALTIME DATA */
onSnapshot(collection(db,"whitelist"),snap=>{
  table.innerHTML="";
  bannedCount=0; totalReferral=0; maxReferral=0;

  document.getElementById("totalWallet").textContent=snap.size;

  snap.forEach(d=>{
    const data=d.data();

    if(data.banned) bannedCount++;
    if(!data.banned){
      totalReferral+=data.refCount||0;
      maxReferral=Math.max(maxReferral,data.refCount||0);
    }

    table.innerHTML+=`
    <tr class="${data.banned?'opacity-40':''}">
      <td class="px-4 py-3">${data.wallet}</td>
      <td class="px-4 py-3">@${data.xUsername}</td>
      <td class="px-4 py-3">${data.refCode}</td>
      <td class="px-4 py-3 ${data.banned?'text-red-400':'text-green-400'}">
        ${data.banned?'BANNED':'ACTIVE'}
      </td>
      <td class="px-4 py-3 text-right">
        <button onclick="toggleBan('${d.id}',${data.banned})"
          class="px-4 py-2 rounded-lg ${data.banned?'bg-blue-600':'bg-red-600'}">
          ${data.banned?'UNBAN':'BAN'}
        </button>
      </td>
    </tr>`;
  });

  document.getElementById("bannedCount").textContent=bannedCount;
  document.getElementById("totalReferral").textContent=totalReferral;
  document.getElementById("topReferral").textContent=maxReferral;
});

/* FUNCTIONS */
window.toggleBan=async(id,status)=>{
  if(!confirm(status?'Unban this user?':'Ban this user?')) return;
  await updateDoc(doc(db,"whitelist",id),{banned:!status});
};

window.exportCSV=()=>{
  let csv="wallet,x,refCode,status\n";
  document.querySelectorAll("#table tr").forEach(r=>{
    const c=r.querySelectorAll("td");
    csv+=`${c[0].innerText},${c[1].innerText},${c[2].innerText},${c[3].innerText}\n`;
  });
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="binggo_whitelist.csv";
  a.click();
};

window.logout=async()=>{
  await signOut(auth);
  location.href="./login.html";
};
</script>

</body>
</html>
